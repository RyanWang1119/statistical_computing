---
title: "project1_RyanWang"
output: html_document
date: "2024-09-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("tidyverse")
library("tidytuesdayR")
library("here")
library("dplyr")
library("gapminder")
library("stringr")

tuesdata <- tidytuesdayR::tt_load("2022-01-18")
chocolate <- tuesdata$chocolate
```


```{r, include=FALSE}
# tests if a directory named "data" exists locally
if (!dir.exists(here("data"))) {
    dir.create(here("data"))
}

# saves data only once (not each time you knit a R Markdown)
if (!file.exists(here("data", "chocolate.RDS"))) {
    url_csv <- "https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-18/chocolate.csv"
    chocolate <- readr::read_csv(url_csv)

    # save the file to RDS objects
    saveRDS(chocolate, file = here("data", "chocolate.RDS"))
}

chocolate <- readRDS(here("data", "chocolate.RDS"))
as_tibble(chocolate)
```

## Part 1

### 1
```{r}
for (i in c(10, 15, 20, 25)) {
  p <- ggplot2::ggplot(data = chocolate, mapping = aes(rating)) + 
       geom_histogram(bins = i)  + # change the number of bins
       labs(x="Rating", y = "Count") 
  print(p)
}

nlevels(as.factor(chocolate$rating))
```
1. The bins argument sets the total number of bins. So, the four plots have number of bins of 10, 15, 20, 25 respectively.
I would pick bins=15, because the variable rating has 12 levels. Choosing the number of bins to be close to it makes the bins neither too dispersive nor clustered together. 

### 2
```{r}
nlevels(as.factor(chocolate$country_of_bean_origin))
levels(as.factor(chocolate$country_of_bean_origin))

reviews_count <- chocolate %>%
  count(country_of_bean_origin, sort = TRUE)

print(reviews_count)

ggplot(data=reviews_count, aes(y=n, x= with(reviews_count, reorder(country_of_bean_origin, n)))) + 
  geom_col() + coord_flip() +
  labs(y="Number of Reviews", x="Bean Origin", title = "Reviews from each Country of Bean Origin") 
```

### 3
```{r}
ecuador_rating <- chocolate %>% filter(country_of_bean_origin == "Ecuador")  # select Ecuador

rating_mean <- mean(ecuador_rating$rating)  # mean rating
rating_num <- length(ecuador_rating$rating)  # number of reviews
rating_sd <- sd(ecuador_rating$rating)  # standard deviation

ecuador_summary <- data.frame(rating_mean, rating_sd, rating_num)
colnames(ecuador_summary) <- c("mean", "sd", "total")

ecuador_summary %>% knitr::kable()
```
3. The average rating is 3.164, the standard deviation of the rating is 0.512. The total number of rating is 219.

### 4
```{r}
ecuador_rating_by_company <- ecuador_rating %>%
  group_by(company_location) %>%  # group by company
  summarize(rating_mean = mean(rating))  # mean rating

ecuador_rating_by_company_sorted <- ecuador_rating_by_company %>% arrange(desc(rating_mean))

best_choco_ecuador <- ecuador_rating_by_company_sorted[1:5,1]
print(best_choco_ecuador)
```
4. Australia has the highest average ratings of 3.81.

### 5
```{r}
choco_rating_by_origin_sorted <- chocolate %>%
  group_by(country_of_bean_origin) %>%  # group by origin
  summarize(rating_mean = mean(rating))%>% arrange(desc(rating_mean))

top_3_country <- choco_rating_by_origin_sorted[1:3,1]
print(top_3_country)
```
5. The top 3 countries with highest ratings on average is Tobago, China, Sao Tome & Principe.

### 6
```{r}
choco_rating_num_by_origin <- chocolate %>%
  group_by(country_of_bean_origin) %>%  # group by origin
  summarize(rating_num = length(rating)) %>% filter(rating_num>=10)  # remove origins with less than 10 reviews

countries_with_10_ratings <- choco_rating_num_by_origin$country_of_bean_origin

chocolate_rating_filtered <- chocolate %>%
  filter(country_of_bean_origin %in% countries_with_10_ratings) %>%
  group_by(country_of_bean_origin) %>%
  summarize(rating_mean = mean(rating))%>% arrange(desc(rating_mean))

top_3_country_filtered <- chocolate_rating_filtered[1:3,1]
print(top_3_country_filtered)
```
6. Now, the to 3 countries with highest ratings are Solomon Islands, Congo, Cuba.

### 7
```{r}
choco_50rating_num_by_origin <- chocolate %>%
  group_by(country_of_bean_origin) %>%  # group by origin
  summarize(rating_num = length(rating)) %>% filter(rating_num>=50)  # at least 50 reviews

countries_with_50_ratings <- choco_50rating_num_by_origin$country_of_bean_origin  

chocolate_50rating <- chocolate %>%
  filter(country_of_bean_origin %in% countries_with_50_ratings) %>% # countries with at least 50 reviews
  mutate(cocoa_percent_numeric = as.numeric(as.numeric(gsub("%", "", cocoa_percent)))) %>%
  mutate(percentage = case_when(cocoa_percent_numeric <60 ~ "<60%",
                      cocoa_percent_numeric>=60 & cocoa_percent_numeric<70 ~ ">=60 to <70%",
                      cocoa_percent_numeric>=70 & cocoa_percent_numeric<90 ~ ">=70 to <90%",
                                cocoa_percent_numeric>=90 ~ ">=90%")) %>% 
  # new column that identify the percentages
  mutate(percentage = as.factor(percentage)) %>%
  mutate(percentage = fct_relevel(percentage, c("<60%", ">=60 to <70%", ">=70 to <90%", ">=90%"))) %>%
  arrange((cocoa_percent_numeric))  

ggplot(chocolate_50rating, aes(y=rating, x=percentage)) + geom_boxplot() +
  facet_wrap(.~country_of_bean_origin)
```

```{r}
chocolate_rating_by_percent <- chocolate_50rating %>%
  group_by(percentage) %>%
  summarize(rating_mean = mean(rating))%>% arrange(desc(rating_mean))
print(chocolate_rating_by_percent)
```
The second category, ">= 60 to <70%" has the highest rating on average. A few countries have disagreements with this result, such as Nicaragua, Mexico, Brazil, Blend, Bellize.

## Part 2
```{r}
gapminder_data <- gapminder %>% select(country, continent)
country_continent <- unique(gapminder_data)

chocolate_reviews_with_continent <- chocolate %>%
  left_join(country_continent, by = c("country_of_bean_origin" = "country"))

chocolate_reviews_with_continent <- chocolate_reviews_with_continent %>% 
  group_by(country_of_bean_origin)  %>%  # group by origin
  filter(n()>=10) %>%  # at least 10 reviews
  filter(country_of_bean_origin != "Blend")  # remove blend

fill_continent <- c(
  "Belize" ="Americas",
  "Congo" ="Africa",
  "Fiji" ="Oceania",
  "Grenada" ="Americas",
  "Papua New Guinea" ="Oceania",
  "Sao Tome" ="Africa",
  "Solomon Islands" ="Oceania",
  "St. Lucia" ="Americas",
  "Trinidad" ="Americas",
  "U.S.A." ="Americas",
  "Vanuatu" ="Oceania"
)

chocolate_reviews_with_continent <-chocolate_reviews_with_continent %>% 
  mutate(continent = ifelse(is.na(continent), as.character(fill_continent[country_of_bean_origin]), as.character(continent)))
# fill the na

chocolate_reviews_with_continent %>%
    ggplot(aes(
        x = as.factor(continent), y = rating)) +
    geom_violin(alpha = 0.6, trim = F) +
  labs(x = "Continent", y = "Rating", title = "Chocolate Ratings in Different Continent",
       caption = "By Ryan Wang")  +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    plot.caption = element_text(size = 10)
  )

```

## Part 3
```{r}
chocolate_part3 <- chocolate %>% 
  mutate(ingredients = ifelse(is.na(ingredients), 'none', ingredients))%>%  # set ingredients to none if na
  mutate(
    beans = if_else(str_detect(ingredients, "B"), 1, 0),
    sugar = if_else(str_detect(ingredients, "S"), 1, 0),
    cocoa_butter = if_else(str_detect(ingredients, "C"), 1, 0),
    vanilla = if_else(str_detect(ingredients, "V"), 1, 0),
    lecithin = if_else(str_detect(ingredients, "L"), 1, 0),
    salt = if_else(str_detect(ingredients, "S"), 1, 0)  # 1
  ) %>%
  
  mutate(
    char_cocoa = if_else(str_detect(most_memorable_characteristics, "cocoa"), 1, 0),
    char_sweet = if_else(str_detect(most_memorable_characteristics, "sweet"), 1, 0),
    char_nutty = if_else(str_detect(most_memorable_characteristics, "nutty"), 1, 0),
    char_creamy = if_else(str_detect(most_memorable_characteristics, "creamy"), 1, 0),
    char_roasty = if_else(str_detect(most_memorable_characteristics, "roasty"), 1, 0),
    char_earthy = if_else(str_detect(most_memorable_characteristics, "earthy"), 1, 0)  # 2
  ) %>%
  
  group_by(review_date) %>%
  summarize(
    beans = mean(beans, na.rm = TRUE),
    sugar = mean(sugar, na.rm = TRUE),
    cocoa_butter = mean(cocoa_butter, na.rm = TRUE),
    vanilla = mean(vanilla, na.rm = TRUE),
    lecithin = mean(lecithin, na.rm = TRUE),
    salt = mean(salt, na.rm = TRUE),
    char_cocoa = mean(char_cocoa, na.rm = TRUE),
    char_sweet = mean(char_sweet, na.rm = TRUE),
    char_nutty = mean(char_nutty, na.rm = TRUE),
    char_creamy = mean(char_creamy, na.rm = TRUE),
    char_roasty = mean(char_roasty, na.rm = TRUE),
    char_earthy = mean(char_earthy, na.rm = TRUE)
  ) %>%
  
  pivot_longer(cols = c("beans", "sugar", "cocoa_butter", "vanilla", "lecithin", 
                        "salt", "char_cocoa", "char_sweet", "char_nutty", "char_creamy",
                        "char_roasty", "char_earthy"), 
               names_to = "feature", 
               values_to = "mean_score")
```

## part 4
```{r, message=FALSE, warning=F}
ggplot(chocolate_part3, aes(y=mean_score, x=review_date)) + geom_point(color = "red", size = 1, alpha = 0.6) +
    geom_smooth(method = "loess", size = 1) + facet_wrap( ~ feature, nrow = 3) +
  labs(title = "Changes in Chocolate Ingredients over Time",
       subtitle = "Vanilla and lecithin have significant decreases through the years, \n while most of the other features remain the same.",
       x = "Review Year", y = "Score",
       caption = "By Ryan Wang") +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12, face = "italic"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    plot.caption = element_text(size = 10)
  )
```

## part 5
```{r}
ggplot(chocolate_50rating, aes(x = rating, y = cocoa_percent_numeric)) +
    geom_point(size = 20, color = "yellow", alpha = 1) +
    geom_point(aes(color = factor(review_date)), size = 15) +
  # 5. Add an excessive, unreadable title and subtitle
  labs(x = "", y = "", 
       title = "Ratings and Cocoa Percent") +
  
  theme(
    plot.background = element_rect(fill = "orange"),
    panel.background = element_rect(fill = "purple"),
    plot.title = element_text(size = 30, face = "bold"),
    legend.position = "left",
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  )

```

- I make the rating be the independent variable and the cocoa percentage the response variable. They should be switched if we want to study how cocoa percentage affects the ratings of chocolates.

- In geom_point(), I set size = 20 to make individual data points extremely large. For a better plot, I might want to change their sizes based on the density of the points.

- In geom_point(), I set alpha = 1 to make data points solid. For a better plot, I might want to change alpha to a lower value to add transparency so that the density of the color can reflect how many points are overlapping.

- In geom_point(), I add aes(color = factor(review_date) so that the color or the points vary with the year of review. It is not necessary since the year of review is not interest of research here. This function can be used when the categorical variable matters, like the penguin example in the lecture.

- In labs(), I omit the labels for x and y axis, which are almost always required in a proper plot.

- In theme(), I customize the color to make the background uncomfortable to see. For a better plot, I might use other colors or functions from theme_park package.

- In theme(), I make the size of the title extremely large and put the legend in an awkward position. For a better plot, I might want to change them in a better way.

-  In theme(), I rotate the labels of the x axis by 90 degree. This function can be used when the words are overlapped and rotating them by some degree can make them better to see.

## part 6
```{r}
chocolate %>%
    ggplot(aes(
        x = as.factor(review_date),
        y = rating,
        fill = review_date
    )) +
    geom_violin(alpha = 0.6, trim = F) + geom_jitter(width = 0.2, size = 1) + 
   scale_fill_gradient(low = "blue", high = "red") + 
  labs(x = "Year", y = "Rating", title = "Chocolate Ratings Over the Years",
       caption = "By Ryan Wang")  +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title.x = element_text(size = 12),
    axis.text.x = element_text(angle = 30),
    axis.title.y = element_text(size = 12),
    plot.caption = element_text(size = 10),
    legend.position = "none",
    panel.grid.major = element_line(colour = "gray80")
  ) 
```

- In geom_violin(), I set alpha = 0.6 to add some transparency, and trim = F to not to trim the tails.

- I add geom_jitter() so that the plot will display the original data. I set width = 0.2 to ensure the data points from a certain year do not overlap with the ones from another year. size = 1 to set the size of the points.

- I add the scale_fill_gradient() and customize the color of the violins such that the color changes from blue to red as year goes.

- I add the labs() to customize the labels of y, x axis, title, and the caption.

- Use theme() to customize the size of the title, labels, and caption.

- In theme(), set legend.position = "none" so that the legend will not be displayed.

- In theme(), use axis.text.x = element_text(angle = 30) to rotate the x-axis labels.

- In theme(), use panel.grid.major = element_line(colour = "gray80") to make the background look differently. 







